{"version":3,"file":"State.js","sourceRoot":"","sources":["../../src/core-state/State.ts"],"names":[],"mappings":"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","sourcesContent":["import { CanvasEngine } from '../CanvasEngine';\r\nimport { Action, ActionEvent, InputType } from '../core-actions/Action';\r\nimport { SyntheticEvent } from 'react';\r\nimport _intersection from 'lodash/intersection';\r\n\r\nexport interface StateOptions {\r\n\tname: string;\r\n}\r\n\r\nexport abstract class State<E extends CanvasEngine = CanvasEngine> {\r\n\tprotected engine: E;\r\n\tprotected actions: Action[];\r\n\tprotected keys: string[];\r\n\tprotected options: StateOptions;\r\n\tprotected childStates: State[];\r\n\r\n\tprivate handler1;\r\n\tprivate handler2;\r\n\r\n\tconstructor(options: StateOptions) {\r\n\t\tthis.actions = [];\r\n\t\tthis.keys = [];\r\n\t\tthis.childStates = [];\r\n\t\tthis.options = options;\r\n\t}\r\n\r\n\tsetEngine(engine: E) {\r\n\t\tthis.engine = engine;\r\n\t}\r\n\r\n\tgetOptions() {\r\n\t\treturn this.options;\r\n\t}\r\n\r\n\teject() {\r\n\t\tthis.engine.getStateMachine().popState();\r\n\t}\r\n\r\n\ttransitionWithEvent(state: State, event: ActionEvent<SyntheticEvent>) {\r\n\t\tthis.engine.getStateMachine().pushState(state);\r\n\t\tthis.engine.getActionEventBus().fireAction(event);\r\n\t}\r\n\r\n\tregisterAction(action: Action) {\r\n\t\tthis.actions.push(action);\r\n\t}\r\n\r\n\ttryActivateParentState(keys: string[]) {\r\n\t\tif (this.keys.length > 0 && !this.isKeysFullfilled(keys)) {\r\n\t\t\tthis.eject();\r\n\t\t\treturn true;\r\n\t\t}\r\n\t\treturn false;\r\n\t}\r\n\r\n\ttryActivateChildState(keys: string[]) {\r\n\t\tconst state = this.findStateToActivate(keys);\r\n\t\tif (state) {\r\n\t\t\tthis.engine.getStateMachine().pushState(state);\r\n\t\t\treturn true;\r\n\t\t}\r\n\t\treturn false;\r\n\t}\r\n\r\n\tfindStateToActivate(keys: string[]) {\r\n\t\tfor (let child of this.childStates) {\r\n\t\t\tif (child.isKeysFullfilled(keys)) {\r\n\t\t\t\treturn child;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn null;\r\n\t}\r\n\r\n\tisKeysFullfilled(keys: string[]) {\r\n\t\treturn _intersection(this.keys, keys).length === this.keys.length;\r\n\t}\r\n\r\n\tactivated(previous: State) {\r\n\t\tconst keys = this.engine.getActionEventBus().getKeys();\r\n\r\n\t\tif (this.tryActivateParentState(keys) || this.tryActivateChildState(keys)) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t// perhaps we need to pop again?\r\n\t\tthis.handler1 = this.engine.getActionEventBus().registerAction(\r\n\t\t\tnew Action({\r\n\t\t\t\ttype: InputType.KEY_DOWN,\r\n\t\t\t\tfire: () => {\r\n\t\t\t\t\tthis.tryActivateChildState(this.engine.getActionEventBus().getKeys());\r\n\t\t\t\t}\r\n\t\t\t})\r\n\t\t);\r\n\r\n\t\tthis.handler2 = this.engine.getActionEventBus().registerAction(\r\n\t\t\tnew Action({\r\n\t\t\t\ttype: InputType.KEY_UP,\r\n\t\t\t\tfire: () => {\r\n\t\t\t\t\tthis.tryActivateParentState(this.engine.getActionEventBus().getKeys());\r\n\t\t\t\t}\r\n\t\t\t})\r\n\t\t);\r\n\r\n\t\tfor (let action of this.actions) {\r\n\t\t\tthis.engine.getActionEventBus().registerAction(action);\r\n\t\t}\r\n\t}\r\n\r\n\tdeactivated(next: State) {\r\n\t\tif (this.handler1) {\r\n\t\t\tthis.handler1();\r\n\t\t}\r\n\t\tif (this.handler2) {\r\n\t\t\tthis.handler2();\r\n\t\t}\r\n\t\t// if this happens, we are going into heirachial state machine mode\r\n\t\tfor (let action of this.actions) {\r\n\t\t\tthis.engine.getActionEventBus().deregisterAction(action);\r\n\t\t}\r\n\t}\r\n}\r\n"]}