{"version":3,"file":"DagreEngine.js","sourceRoot":"","sources":["../../src/dagre/DagreEngine.ts"],"names":[],"mappings":"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","sourcesContent":["import { DiagramModel, PointModel } from '@projectstorm/react-diagrams-core';\r\nimport * as dagre from 'dagre';\r\nimport { GraphLabel } from 'dagre';\r\nimport _every from 'lodash/every';\r\nimport _findIndex from 'lodash/findIndex';\r\nimport _forEach from 'lodash/forEach';\r\nimport _map from 'lodash/map';\r\nimport _range from 'lodash/range';\r\nimport _sortBy from 'lodash/sortBy';\r\nimport { Point } from '@projectstorm/geometry';\r\n\r\nexport interface DagreEngineOptions {\r\n\tgraph?: GraphLabel;\r\n\t/**\r\n\t * Will also re-layout links\r\n\t */\r\n\tincludeLinks?: boolean;\r\n\tnodeMargin?: number;\r\n}\r\n\r\nexport class DagreEngine {\r\n\toptions: DagreEngineOptions;\r\n\r\n\tconstructor(options: DagreEngineOptions = {}) {\r\n\t\tthis.options = options;\r\n\t}\r\n\r\n\tredistribute(model: DiagramModel) {\r\n\t\t// Create a new directed graph\r\n\t\tvar g = new dagre.graphlib.Graph({\r\n\t\t\tmultigraph: true,\r\n\t\t\tcompound: true\r\n\t\t});\r\n\t\tg.setGraph(this.options.graph || {});\r\n\t\tg.setDefaultEdgeLabel(function () {\r\n\t\t\treturn {};\r\n\t\t});\r\n\r\n\t\t// set nodes\r\n\t\t_forEach(model.getNodes(), (node) => {\r\n\t\t\tg.setNode(node.getID(), { width: node.width, height: node.height });\r\n\t\t});\r\n\r\n\t\t_forEach(model.getLinks(), (link) => {\r\n\t\t\t// set edges\r\n\t\t\tif (link.getSourcePort() && link.getTargetPort()) {\r\n\t\t\t\tg.setEdge({\r\n\t\t\t\t\tv: link.getSourcePort().getNode().getID(),\r\n\t\t\t\t\tw: link.getTargetPort().getNode().getID(),\r\n\t\t\t\t\tname: link.getID()\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\t// layout the graph\r\n\t\tdagre.layout(g);\r\n\r\n\t\tg.nodes().forEach((v) => {\r\n\t\t\tconst node = g.node(v);\r\n\t\t\tmodel.getNode(v).setPosition(node.x - node.width / 2, node.y - node.height / 2);\r\n\t\t});\r\n\r\n\t\t// also include links?\r\n\t\tif (this.options.includeLinks) {\r\n\t\t\tg.edges().forEach((e) => {\r\n\t\t\t\tconst edge = g.edge(e);\r\n\t\t\t\tconst link = model.getLink(e.name);\r\n\r\n\t\t\t\tconst points = [link.getFirstPoint()];\r\n\t\t\t\tfor (let i = 1; i < edge.points.length - 1; i++) {\r\n\t\t\t\t\tpoints.push(new PointModel({ link: link, position: new Point(edge.points[i].x, edge.points[i].y) }));\r\n\t\t\t\t}\r\n\t\t\t\tlink.setPoints(points.concat(link.getLastPoint()));\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * TODO cleanup this method into smaller methods\r\n\t */\r\n\tpublic refreshLinks(diagram: DiagramModel) {\r\n\t\tconst { nodeMargin } = this.options;\r\n\t\tconst nodes = diagram.getNodes();\r\n\t\tconst links = diagram.getLinks();\r\n\t\tlet maxChunkRowIndex = -1;\r\n\t\t// build the chunk matrix\r\n\t\tconst chunks: { [id: number]: { [id: number]: boolean } } = {}; // true: occupied, false: blank\r\n\t\tconst NodeXColumnIndexDictionary: { [id: number]: number } = {};\r\n\t\tlet verticalLines: number[] = [];\r\n\t\t_forEach(nodes, (node) => {\r\n\t\t\t// find vertical lines. vertical lines go through maximum number of nodes located under each other.\r\n\t\t\tconst nodeColumnCenter = node.getX() + node.width / 2;\r\n\t\t\tif (\r\n\t\t\t\t_every(verticalLines, (vLine) => {\r\n\t\t\t\t\treturn Math.abs(nodeColumnCenter - vLine) > nodeMargin;\r\n\t\t\t\t})\r\n\t\t\t) {\r\n\t\t\t\tverticalLines.push(nodeColumnCenter);\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\t// sort chunk columns\r\n\t\tverticalLines = verticalLines.sort((a, b) => a - b);\r\n\t\t_forEach(verticalLines, (line, index) => {\r\n\t\t\tchunks[index] = {};\r\n\t\t\tchunks[index + 0.5] = {};\r\n\t\t});\r\n\r\n\t\t// set occupied chunks\r\n\t\t_forEach(nodes, (node) => {\r\n\t\t\tconst nodeColumnCenter = node.getX() + node.width / 2;\r\n\t\t\tconst startChunkIndex = Math.floor(node.getY() / nodeMargin);\r\n\t\t\tconst endChunkIndex = Math.floor((node.getY() + node.height) / nodeMargin);\r\n\t\t\t// find max ChunkRowIndex\r\n\t\t\tif (endChunkIndex > maxChunkRowIndex) maxChunkRowIndex = endChunkIndex;\r\n\t\t\tconst nodeColumnIndex = _findIndex(verticalLines, (vLine) => {\r\n\t\t\t\treturn Math.abs(nodeColumnCenter - vLine) <= nodeMargin;\r\n\t\t\t});\r\n\t\t\t_forEach(_range(startChunkIndex, endChunkIndex + 1), (chunkIndex) => {\r\n\t\t\t\tchunks[nodeColumnIndex][chunkIndex] = true;\r\n\t\t\t});\r\n\t\t\tNodeXColumnIndexDictionary[node.getX()] = nodeColumnIndex;\r\n\t\t});\r\n\r\n\t\t// sort links based on their distances\r\n\t\tconst edges = _map(links, (link) => {\r\n\t\t\tif (link.getSourcePort() && link.getTargetPort()) {\r\n\t\t\t\tconst source = link.getSourcePort().getNode();\r\n\t\t\t\tconst target = link.getTargetPort().getNode();\r\n\t\t\t\tconst sourceIndex = NodeXColumnIndexDictionary[source.getX()];\r\n\t\t\t\tconst targetIndex = NodeXColumnIndexDictionary[target.getX()];\r\n\r\n\t\t\t\treturn sourceIndex > targetIndex\r\n\t\t\t\t\t? {\r\n\t\t\t\t\t\t\tlink,\r\n\t\t\t\t\t\t\tsourceIndex,\r\n\t\t\t\t\t\t\tsourceY: source.getY() + source.height / 2,\r\n\t\t\t\t\t\t\tsource,\r\n\t\t\t\t\t\t\ttargetIndex,\r\n\t\t\t\t\t\t\ttargetY: target.getY() + source.height / 2,\r\n\t\t\t\t\t\t\ttarget\r\n\t\t\t\t\t  }\r\n\t\t\t\t\t: {\r\n\t\t\t\t\t\t\tlink,\r\n\t\t\t\t\t\t\tsourceIndex: targetIndex,\r\n\t\t\t\t\t\t\tsourceY: target.getY() + target.height / 2,\r\n\t\t\t\t\t\t\tsource: target,\r\n\t\t\t\t\t\t\ttargetIndex: sourceIndex,\r\n\t\t\t\t\t\t\ttargetY: source.getY() + source.height / 2,\r\n\t\t\t\t\t\t\ttarget: source\r\n\t\t\t\t\t  };\r\n\t\t\t}\r\n\t\t});\r\n\t\tconst sortedEdges = _sortBy(edges, (link) => {\r\n\t\t\treturn Math.abs(link.targetIndex - link.sourceIndex);\r\n\t\t});\r\n\r\n\t\t// set link points\r\n\t\tif (this.options.includeLinks) {\r\n\t\t\t_forEach(sortedEdges, (edge) => {\r\n\t\t\t\tconst link = diagram.getLink(edge.link.getID());\r\n\t\t\t\t// re-draw\r\n\t\t\t\tif (Math.abs(edge.sourceIndex - edge.targetIndex) > 1) {\r\n\t\t\t\t\t// get the length of link in column\r\n\t\t\t\t\tconst columns = _range(edge.sourceIndex - 1, edge.targetIndex);\r\n\r\n\t\t\t\t\tconst chunkIndex = Math.floor(edge.sourceY / nodeMargin);\r\n\t\t\t\t\tconst targetChunkIndex = Math.floor(edge.targetY / nodeMargin);\r\n\r\n\t\t\t\t\t// check upper paths\r\n\t\t\t\t\tlet northCost = 1;\r\n\t\t\t\t\tlet aboveRowIndex = chunkIndex;\r\n\t\t\t\t\tfor (; aboveRowIndex >= 0; aboveRowIndex--, northCost++) {\r\n\t\t\t\t\t\tif (\r\n\t\t\t\t\t\t\t_every(columns, (columnIndex) => {\r\n\t\t\t\t\t\t\t\treturn !(\r\n\t\t\t\t\t\t\t\t\tchunks[columnIndex][aboveRowIndex] ||\r\n\t\t\t\t\t\t\t\t\tchunks[columnIndex + 0.5][aboveRowIndex] ||\r\n\t\t\t\t\t\t\t\t\tchunks[columnIndex - 0.5][aboveRowIndex]\r\n\t\t\t\t\t\t\t\t);\r\n\t\t\t\t\t\t\t})\r\n\t\t\t\t\t\t) {\r\n\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t// check lower paths\r\n\t\t\t\t\tlet southCost = 0;\r\n\t\t\t\t\tlet belowRowIndex = chunkIndex;\r\n\t\t\t\t\tfor (; belowRowIndex <= maxChunkRowIndex; belowRowIndex++, southCost++) {\r\n\t\t\t\t\t\tif (\r\n\t\t\t\t\t\t\t_every(columns, (columnIndex) => {\r\n\t\t\t\t\t\t\t\treturn !(\r\n\t\t\t\t\t\t\t\t\tchunks[columnIndex][belowRowIndex] ||\r\n\t\t\t\t\t\t\t\t\tchunks[columnIndex + 0.5][belowRowIndex] ||\r\n\t\t\t\t\t\t\t\t\tchunks[columnIndex - 0.5][belowRowIndex]\r\n\t\t\t\t\t\t\t\t);\r\n\t\t\t\t\t\t\t})\r\n\t\t\t\t\t\t) {\r\n\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\t// pick the cheapest path\r\n\t\t\t\t\tconst pathRowIndex =\r\n\t\t\t\t\t\tsouthCost + (belowRowIndex - targetChunkIndex) < northCost + (targetChunkIndex - aboveRowIndex)\r\n\t\t\t\t\t\t\t? belowRowIndex + 1\r\n\t\t\t\t\t\t\t: aboveRowIndex - 1;\r\n\r\n\t\t\t\t\t// Finally update the link points\r\n\t\t\t\t\tconst points = [link.getFirstPoint()];\r\n\t\t\t\t\tpoints.push(\r\n\t\t\t\t\t\tnew PointModel({\r\n\t\t\t\t\t\t\tlink: link,\r\n\t\t\t\t\t\t\tposition: new Point(\r\n\t\t\t\t\t\t\t\t(verticalLines[columns[0]] + verticalLines[columns[0] + 1]) / 2,\r\n\t\t\t\t\t\t\t\t(pathRowIndex + 0.5) * nodeMargin\r\n\t\t\t\t\t\t\t)\r\n\t\t\t\t\t\t})\r\n\t\t\t\t\t);\r\n\r\n\t\t\t\t\t_forEach(columns, (column) => {\r\n\t\t\t\t\t\tpoints.push(\r\n\t\t\t\t\t\t\tnew PointModel({\r\n\t\t\t\t\t\t\t\tlink: link,\r\n\t\t\t\t\t\t\t\tposition: new Point(verticalLines[column], (pathRowIndex + 0.5) * nodeMargin)\r\n\t\t\t\t\t\t\t})\r\n\t\t\t\t\t\t);\r\n\t\t\t\t\t\tpoints.push(\r\n\t\t\t\t\t\t\tnew PointModel({\r\n\t\t\t\t\t\t\t\tlink: link,\r\n\t\t\t\t\t\t\t\tposition: new Point(\r\n\t\t\t\t\t\t\t\t\t(verticalLines[column] + verticalLines[column - 1]) / 2,\r\n\t\t\t\t\t\t\t\t\t(pathRowIndex + 0.5) * nodeMargin\r\n\t\t\t\t\t\t\t\t)\r\n\t\t\t\t\t\t\t})\r\n\t\t\t\t\t\t);\r\n\t\t\t\t\t\tchunks[column][pathRowIndex] = true;\r\n\t\t\t\t\t\tchunks[column][pathRowIndex + 1] = true;\r\n\t\t\t\t\t\tchunks[column + 0.5][pathRowIndex] = true;\r\n\t\t\t\t\t\tchunks[column + 0.5][pathRowIndex + 1] = true;\r\n\t\t\t\t\t});\r\n\t\t\t\t\tlink.setPoints(points.concat(link.getLastPoint()));\r\n\t\t\t\t} else {\r\n\t\t\t\t\t// refresh\r\n\t\t\t\t\tlink.setPoints([link.getFirstPoint(), link.getLastPoint()]);\r\n\t\t\t\t\tconst columnIndex = (edge.sourceIndex + edge.targetIndex) / 2;\r\n\t\t\t\t\tif (!chunks[columnIndex]) {\r\n\t\t\t\t\t\tchunks[columnIndex] = {};\r\n\t\t\t\t\t}\r\n\t\t\t\t\tconst rowIndex = Math.floor((edge.sourceY + edge.targetY) / 2 / nodeMargin);\r\n\t\t\t\t\tchunks[columnIndex][rowIndex] = true;\r\n\t\t\t\t\tchunks[columnIndex][rowIndex + 1] = true;\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n}\r\n"]}