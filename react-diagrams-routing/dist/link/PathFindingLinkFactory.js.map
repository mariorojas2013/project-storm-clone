{"version":3,"file":"PathFindingLinkFactory.js","sourceRoot":"","sources":["../../src/link/PathFindingLinkFactory.tsx"],"names":[],"mappings":"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","sourcesContent":["import * as React from 'react';\r\nimport { DiagramEngine } from '@projectstorm/react-diagrams-core';\r\nimport { PathFindingLinkModel } from './PathFindingLinkModel';\r\nimport { PathFindingLinkWidget } from './PathFindingLinkWidget';\r\nimport _cloneDeep from 'lodash/cloneDeep';\r\nimport _concat from 'lodash/concat';\r\nimport _defer from 'lodash/defer';\r\nimport _flatMap from 'lodash/flatMap';\r\nimport _get from 'lodash/get';\r\nimport _minBy from 'lodash/minBy';\r\nimport _maxBy from 'lodash/maxBy';\r\nimport _range from 'lodash/range';\r\nimport _reduce from 'lodash/reduce';\r\nimport _values from 'lodash/values';\r\nimport * as Path from 'paths-js/path';\r\nimport { DefaultLinkFactory } from '@projectstorm/react-diagrams-defaults';\r\nimport {\r\n\tAbstractDisplacementState,\r\n\tAbstractFactory,\r\n\tAction,\r\n\tFactoryBank,\r\n\tInputType,\r\n\tListenerHandle\r\n} from '@projectstorm/react-canvas-core';\r\n\r\nexport class PathFindingLinkFactory extends DefaultLinkFactory<PathFindingLinkModel> {\r\n\tROUTING_SCALING_FACTOR: number = 5;\r\n\r\n\t// calculated only when smart routing is active\r\n\tcanvasMatrix: number[][] = [];\r\n\troutingMatrix: number[][] = [];\r\n\r\n\t// used when at least one element has negative coordinates\r\n\thAdjustmentFactor: number = 0;\r\n\tvAdjustmentFactor: number = 0;\r\n\r\n\tstatic NAME = 'pathfinding';\r\n\tlistener: ListenerHandle;\r\n\r\n\tconstructor() {\r\n\t\tsuper(PathFindingLinkFactory.NAME);\r\n\t}\r\n\r\n\tsetDiagramEngine(engine: DiagramEngine): void {\r\n\t\tsuper.setDiagramEngine(engine);\r\n\r\n\t\t// listen for drag changes\r\n\t\tengine.getStateMachine().registerListener({\r\n\t\t\tstateChanged: (event) => {\r\n\t\t\t\tif (event.newState instanceof AbstractDisplacementState) {\r\n\t\t\t\t\tconst deRegister = engine.getActionEventBus().registerAction(\r\n\t\t\t\t\t\tnew Action<DiagramEngine>({\r\n\t\t\t\t\t\t\ttype: InputType.MOUSE_UP,\r\n\t\t\t\t\t\t\tfire: () => {\r\n\t\t\t\t\t\t\t\tthis.calculateRoutingMatrix();\r\n\t\t\t\t\t\t\t\tengine.repaintCanvas();\r\n\t\t\t\t\t\t\t\tdeRegister();\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t})\r\n\t\t\t\t\t);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\t\tthis.listener = engine.registerListener({\r\n\t\t\tcanvasReady: () => {\r\n\t\t\t\t_defer(() => {\r\n\t\t\t\t\tthis.calculateRoutingMatrix();\r\n\t\t\t\t\tengine.repaintCanvas();\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tsetFactoryBank(bank: FactoryBank<AbstractFactory>): void {\r\n\t\tsuper.setFactoryBank(bank);\r\n\t\tif (!bank && this.listener) {\r\n\t\t\tthis.listener.deregister();\r\n\t\t}\r\n\t}\r\n\r\n\tgenerateReactWidget(event): JSX.Element {\r\n\t\treturn <PathFindingLinkWidget diagramEngine={this.engine} link={event.model} factory={this} />;\r\n\t}\r\n\r\n\tgenerateModel(event): PathFindingLinkModel {\r\n\t\treturn new PathFindingLinkModel();\r\n\t}\r\n\r\n\t/**\r\n\t * A representation of the canvas in the following format:\r\n\t *\r\n\t * +-----------------+\r\n\t * | 0 0 0 0 0 0 0 0 |\r\n\t * | 0 0 0 0 0 0 0 0 |\r\n\t * | 0 0 0 0 0 0 0 0 |\r\n\t * | 0 0 0 0 0 0 0 0 |\r\n\t * | 0 0 0 0 0 0 0 0 |\r\n\t * +-----------------+\r\n\t *\r\n\t * In which all walkable points are marked by zeros.\r\n\t * It uses @link{#ROUTING_SCALING_FACTOR} to reduce the matrix dimensions and improve performance.\r\n\t */\r\n\tgetCanvasMatrix(): number[][] {\r\n\t\tif (this.canvasMatrix.length === 0) {\r\n\t\t\tthis.calculateCanvasMatrix();\r\n\t\t}\r\n\r\n\t\treturn this.canvasMatrix;\r\n\t}\r\n\tcalculateCanvasMatrix() {\r\n\t\tconst {\r\n\t\t\twidth: canvasWidth,\r\n\t\t\thAdjustmentFactor,\r\n\t\t\theight: canvasHeight,\r\n\t\t\tvAdjustmentFactor\r\n\t\t} = this.calculateMatrixDimensions();\r\n\r\n\t\tthis.hAdjustmentFactor = hAdjustmentFactor;\r\n\t\tthis.vAdjustmentFactor = vAdjustmentFactor;\r\n\r\n\t\tconst matrixWidth = Math.ceil(canvasWidth / this.ROUTING_SCALING_FACTOR);\r\n\t\tconst matrixHeight = Math.ceil(canvasHeight / this.ROUTING_SCALING_FACTOR);\r\n\r\n\t\tthis.canvasMatrix = _range(0, matrixHeight).map(() => {\r\n\t\t\treturn new Array(matrixWidth).fill(0);\r\n\t\t});\r\n\t}\r\n\r\n\t/**\r\n\t * A representation of the canvas in the following format:\r\n\t *\r\n\t * +-----------------+\r\n\t * | 0 0 1 1 0 0 0 0 |\r\n\t * | 0 0 1 1 0 0 1 1 |\r\n\t * | 0 0 0 0 0 0 1 1 |\r\n\t * | 1 1 0 0 0 0 0 0 |\r\n\t * | 1 1 0 0 0 0 0 0 |\r\n\t * +-----------------+\r\n\t *\r\n\t * In which all points blocked by a node (and its ports) are\r\n\t * marked as 1; points were there is nothing (ie, free) receive 0.\r\n\t */\r\n\tgetRoutingMatrix(): number[][] {\r\n\t\tif (this.routingMatrix.length === 0) {\r\n\t\t\tthis.calculateRoutingMatrix();\r\n\t\t}\r\n\r\n\t\treturn this.routingMatrix;\r\n\t}\r\n\tcalculateRoutingMatrix(): void {\r\n\t\tconst matrix = _cloneDeep(this.getCanvasMatrix());\r\n\r\n\t\t// nodes need to be marked as blocked points\r\n\t\tthis.markNodes(matrix);\r\n\t\t// same thing for ports\r\n\t\tthis.markPorts(matrix);\r\n\r\n\t\tthis.routingMatrix = matrix;\r\n\t}\r\n\r\n\t/**\r\n\t * The routing matrix does not have negative indexes, but elements could be negatively positioned.\r\n\t * We use the functions below to translate back and forth between these coordinates, relying on the\r\n\t * calculated values of hAdjustmentFactor and vAdjustmentFactor.\r\n\t */\r\n\ttranslateRoutingX(x: number, reverse: boolean = false) {\r\n\t\treturn x + this.hAdjustmentFactor * (reverse ? -1 : 1);\r\n\t}\r\n\ttranslateRoutingY(y: number, reverse: boolean = false) {\r\n\t\treturn y + this.vAdjustmentFactor * (reverse ? -1 : 1);\r\n\t}\r\n\r\n\t/**\r\n\t * Despite being a long method, we simply iterate over all three collections (nodes, ports and points)\r\n\t * to find the highest X and Y dimensions, so we can build the matrix large enough to contain all elements.\r\n\t */\r\n\tcalculateMatrixDimensions = (): {\r\n\t\twidth: number;\r\n\t\thAdjustmentFactor: number;\r\n\t\theight: number;\r\n\t\tvAdjustmentFactor: number;\r\n\t} => {\r\n\t\tconst allNodesCoords = _values(this.engine.getModel().getNodes()).map((item) => ({\r\n\t\t\tx: item.getX(),\r\n\t\t\twidth: item.width,\r\n\t\t\ty: item.getY(),\r\n\t\t\theight: item.height\r\n\t\t}));\r\n\r\n\t\tconst allLinks = _values(this.engine.getModel().getLinks());\r\n\t\tconst allPortsCoords = _flatMap(allLinks.map((link) => [link.getSourcePort(), link.getTargetPort()]))\r\n\t\t\t.filter((port) => port !== null)\r\n\t\t\t.map((item) => ({\r\n\t\t\t\tx: item.getX(),\r\n\t\t\t\twidth: item.width,\r\n\t\t\t\ty: item.getY(),\r\n\t\t\t\theight: item.height\r\n\t\t\t}));\r\n\t\tconst allPointsCoords = _flatMap(allLinks.map((link) => link.getPoints())).map((item) => ({\r\n\t\t\t// points don't have width/height, so let's just use 0\r\n\t\t\tx: item.getX(),\r\n\t\t\twidth: 0,\r\n\t\t\ty: item.getY(),\r\n\t\t\theight: 0\r\n\t\t}));\r\n\r\n\t\tconst sumProps = (object, props) => _reduce(props, (acc, prop) => acc + _get(object, prop, 0), 0);\r\n\r\n\t\tconst canvas = this.engine.getCanvas() as HTMLDivElement;\r\n\t\tconst concatedCoords = _concat(allNodesCoords, allPortsCoords, allPointsCoords);\r\n\t\tconst minX =\r\n\t\t\tMath.floor(Math.min(_get(_minBy(concatedCoords, 'x'), 'x', 0), 0) / this.ROUTING_SCALING_FACTOR) *\r\n\t\t\tthis.ROUTING_SCALING_FACTOR;\r\n\t\tconst maxXElement = _maxBy(concatedCoords, (item) => sumProps(item, ['x', 'width']));\r\n\t\tconst maxX = Math.max(sumProps(maxXElement, ['x', 'width']), canvas.offsetWidth);\r\n\t\tconst minYCoords = _minBy(concatedCoords, 'y');\r\n\t\tconst minY =\r\n\t\t\tMath.floor(Math.min(_get(minYCoords, 'y', 0), 0) / this.ROUTING_SCALING_FACTOR) * this.ROUTING_SCALING_FACTOR;\r\n\t\tconst maxYElement = _maxBy(concatedCoords, (item) => sumProps(item, ['y', 'height']));\r\n\t\tconst maxY = Math.max(sumProps(maxYElement, ['y', 'height']), canvas.offsetHeight);\r\n\r\n\t\treturn {\r\n\t\t\twidth: Math.ceil(Math.abs(minX) + maxX),\r\n\t\t\thAdjustmentFactor: Math.abs(minX) / this.ROUTING_SCALING_FACTOR + 1,\r\n\t\t\theight: Math.ceil(Math.abs(minY) + maxY),\r\n\t\t\tvAdjustmentFactor: Math.abs(minY) / this.ROUTING_SCALING_FACTOR + 1\r\n\t\t};\r\n\t};\r\n\r\n\t/**\r\n\t * Updates (by reference) where nodes will be drawn on the matrix passed in.\r\n\t */\r\n\tmarkNodes = (matrix: number[][]): void => {\r\n\t\t_values(this.engine.getModel().getNodes()).forEach((node) => {\r\n\t\t\tconst startX = Math.floor(node.getX() / this.ROUTING_SCALING_FACTOR);\r\n\t\t\tconst endX = Math.ceil((node.getX() + node.width) / this.ROUTING_SCALING_FACTOR);\r\n\t\t\tconst startY = Math.floor(node.getY() / this.ROUTING_SCALING_FACTOR);\r\n\t\t\tconst endY = Math.ceil((node.getY() + node.height) / this.ROUTING_SCALING_FACTOR);\r\n\r\n\t\t\tfor (let x = startX - 1; x <= endX + 1; x++) {\r\n\t\t\t\tfor (let y = startY - 1; y < endY + 1; y++) {\r\n\t\t\t\t\tthis.markMatrixPoint(matrix, this.translateRoutingX(x), this.translateRoutingY(y));\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\t};\r\n\r\n\t/**\r\n\t * Updates (by reference) where ports will be drawn on the matrix passed in.\r\n\t */\r\n\tmarkPorts = (matrix: number[][]): void => {\r\n\t\tconst allElements = _flatMap(\r\n\t\t\t_values(this.engine.getModel().getLinks()).map((link) => [].concat(link.getSourcePort(), link.getTargetPort()))\r\n\t\t);\r\n\t\tallElements\r\n\t\t\t.filter((port) => port !== null)\r\n\t\t\t.forEach((port) => {\r\n\t\t\t\tconst startX = Math.floor(port.x / this.ROUTING_SCALING_FACTOR);\r\n\t\t\t\tconst endX = Math.ceil((port.x + port.width) / this.ROUTING_SCALING_FACTOR);\r\n\t\t\t\tconst startY = Math.floor(port.y / this.ROUTING_SCALING_FACTOR);\r\n\t\t\t\tconst endY = Math.ceil((port.y + port.height) / this.ROUTING_SCALING_FACTOR);\r\n\r\n\t\t\t\tfor (let x = startX - 1; x <= endX + 1; x++) {\r\n\t\t\t\t\tfor (let y = startY - 1; y < endY + 1; y++) {\r\n\t\t\t\t\t\tthis.markMatrixPoint(matrix, this.translateRoutingX(x), this.translateRoutingY(y));\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t};\r\n\r\n\tmarkMatrixPoint = (matrix: number[][], x: number, y: number) => {\r\n\t\tif (matrix[y] !== undefined && matrix[y][x] !== undefined) {\r\n\t\t\tmatrix[y][x] = 1;\r\n\t\t}\r\n\t};\r\n\r\n\tgenerateDynamicPath(pathCoords: number[][]) {\r\n\t\tlet path = Path();\r\n\t\tpath = path.moveto(pathCoords[0][0] * this.ROUTING_SCALING_FACTOR, pathCoords[0][1] * this.ROUTING_SCALING_FACTOR);\r\n\t\tpathCoords.slice(1).forEach((coords) => {\r\n\t\t\tpath = path.lineto(coords[0] * this.ROUTING_SCALING_FACTOR, coords[1] * this.ROUTING_SCALING_FACTOR);\r\n\t\t});\r\n\t\treturn path.print();\r\n\t}\r\n}\r\n"]}